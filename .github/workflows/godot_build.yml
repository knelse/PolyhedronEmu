name: Godot build

on:
  workflow_run:
    workflows: ["Python lint & test"]
    types:
      - completed
    branches: [master]

jobs:
  Godot:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions: write-all
    strategy:
      matrix:
        platform: [win64]
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup py4godot for export
        run: |
          echo "Setting up py4godot for headless export..."
          
          # Create .godot directory if it doesn't exist
          mkdir -p .godot/
          
          # Ensure project settings recognize the GDExtension
          echo "Checking project.godot for GDExtension configuration..."
          if ! grep -q "py4godot" project.godot; then
            echo "Adding py4godot addon to project.godot"
            echo "" >> project.godot
            echo "[addon]" >> project.godot
            echo "" >> project.godot
            echo "py4godot/enabled=true" >> project.godot
          fi

      - name: Export artifacts
        id: export
        uses: firebelley/godot-export@v6.0.0
        with:
          godot_executable_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
          relative_project_path: ./

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: PolyhedronEmu - ${{ matrix.platform }}
          path: ${{ steps.export.outputs.archive_directory }}/*
